*Red Hat Enterprise Linux Diagnostics & Troubleshooting (RH342)*
==========================================================================

# Persisting journal:
mkdir /var/log/journal<br/>
chown root:systemd-journal /var/log/journal<br/>
chmod 2755 /var/log/journal<br/>
killall -USR1 systemd-journal                   # or reboot<br/>


# journalctl examples:
journalctl -ef                                  # end & follow<br/>
journalctl _SYSTEMD_UNIT=sshd.service           # generated by sshd service<br/>
journalctl -u sshd.service                      # generated and about sshd service<br/>
journalctl -p emerg..err                        # priority between emergency and error<br/>
journalctl -b -1                                # only from the last boot<br/>
journalctl --since "2019-01-01 20:30:00" --until "2019-02-02 12:00:00"<br/>
journalctl -o verbose                           # show all fields<br/>

# Using RH resources:
yum -y install sos<br/>
sosreport --help | less<br/>
sosreport -l | less                             # view currently enabled/disabled plugins and plugin options<br/>
sosreport -o <PLUGIN(S)>                        # enable these plugins only (it will only run these plugins)<br/>
sosreport -n <PLUGIN(S)>                        # skip these plugins (it will run all of the plugins, except for these)<br/>
sosreport -e <PLUGIN(S)>                        # enable previously disabled plugins<br/>
sosreport -k xfs.logprint                       # xfs module and logprint option enabled<br/>
redhat-support-tool<br/>
# Insights:
yum -y install redhat-access-insights<br/>
redhat-access-insights --register<br/>
# Cockpit:
yum -y install cockpit<br/>
systemctl start cockpit<br/>
firewall-cmd -add-service=cockpit --permanent<br/>
firewall-cmd --reload                           # http://localhost:9090<br/>

# Co-pilot:
yum -y install pcp                              # performance co-pilot<br/>
systemctl start pmcd                            # performance metrics collector daemon<br/>
systemctl enable pmcd<br/>
pmstat -s 5                                     # 5 samples<br/>
pmatop                                          # machine stats and data<br/>
pminfo                                          # obtain list of metrics<br/>
pminfo -dt proc.nprocs                          # understand specific metric<br/>
pmval -s 5 proc.nprocs                          # gather sample data about the metric 5x times<br/>
pmval -T 1minute kernel.percpu.cpu.idle         # per-CPU idle time for one minute<br/>

# Historical data:
systemctl start pmlogger                        # ability to store metrics data to logs (-a <ARCHIVE>)<br/>
systemctl enable pmlogger<br/>
pcp | grep 'primary logger'                     # location of the archive log that pmlogger is writing to<br/>
ls /var/log/pcp/pmlogger/<HOSTNAME>             # collects data every second to this location<br/>
pmval -a <ARCHIVE.xz> -f 3 <METRIC>             # performance metrics value dump from archive with 3 digits precision<br/>
pmval -a /var/log/pcp/pmlogger/serverX.example.com/20190101.00.10.0 kernel.all.load<br/>
pmval -a /var/log/pcp/pmlogger/serverX.example.com/20190101.00.10.0 kernel.all.load \<br/>
  -S '@ Tue Feb 01 12:00:00 2019' -T '@ Tue Feb 01 13:00:00 2019'<br/>
# Configure central log host:
systemctl is-active rsyslog<br/>
systemctl is-enabled rsyslog<br/>
man rsyslog.conf                                # man pages<br/>
vim /etc/rsyslog.conf<br/>
  $ModLoad imudp.so                             # for UDP<br/>
  $UDPServerRun 514<br/>

  $ModLoad imtcp.so                             # for TCP<br/>
  $InputTCPServerRun 514<br/>

  $template DynamicFile,"/var/log/loghost/%HOSTNAME%/cron.log"<br/>
  cron.* ?DynamicFile                           # 'DyamicFile' here is arbitrary template name<br/>

  $template DynamicFile,"/var/log/loghost/%HOSTNAME%/%syslogfacility-text%.log"<br/>
  *.* -?DynamicFile                             # minus is turn off syncing of the log file after each write<br/>
systemctl restart rsyslog<br/>
firewall-cmd --add-port=514/udp --permanent<br/>
firewall-cmd --add-port=514/tcp --permanent<br/>
firewall-cmd --reload<br/>

# Enable log rotation:
vim /etc/logrotate.d/syslog<br/>
  /var/log/loghost/*/*.log                      # must not be at the end, but before curly braces {...}<br/>
# Redirecting logging to central host:
vim /etc/rsyslog.conf<br/>
  *.info @loghost.example.com[:PORT]            # all info messages sent to loghost.example.com via UDP<br/>
  *.* @@loghost.example.com                     # all messages sent to loghost.example.com via TCP<br/>
# Monitor changes:
yum -y install aide                             # intrusion detection<br/>
vim /etc/aide.conf<br/>
  # Configuration lines:
  PERMS = p+i+u+g+acl+selinux                   # file (p)ermissions, (i)node, (u)ser/(g)roup ownership, acl, selinux<br/>

  # Selection lines:
  /dir1 PERMS                                   # group check on dir1 and all files and dirs below it<br/>
  =/dir2 PERMS                                  # group check in dir2, but not recursively<br/>
  !/dir3                                        # excludes dir3 and all files below it from any checks<br/>

  # Macro lines:
  @@define VAR value                            # @@{VAR} is reference to the macro defined previously<br/>
aide --init                                     # creates /var/lib/aide/aide.db.new.gz every time<br/>
mv -v /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz<br/>
aide --check<br/>
# File system auditing:
man audit.rules                                 # manpages<br/>
auditctl -w /etc/passwd -p wa -k <KEY>          # watch rule for write and attribute changes with custom key<br/>
auditctl -w /etc/sysconfig -p rwa -k <KEY>      # recursive watch of all files and dirs in sysconfig & key<br/>
auditctl -w /bin -p x                           # all executions in bin<br/>
auditctl -W <PATH>                              # remove watch rule(s) at path<br/>
auditctl -d <RULE>                              # remove previous -a or -A rule(s)<br/>
auditctl -D                                     # remove all rules (or they get removed by reboot)<br/>
vim /etc/audit/rules.d/audit.rules              # persistent rules, without auditctl at the beginning<br/>
  -w /etc -p w -k etc_content                   # w=path, p=permission((r)ead,(w)rite,e(x)ecute,(a)ttribute)<br/>
  -w /etc -p a -k etc_attribute<br/>
# System calls auditing:
auditctl -a always,exit -F arch=b64 -S open\    # list names:task,exit,user,exclude actions:never,always<br/>
  -F success=0                                  # system call open() that failed<br/>
cat /var/log/audit/audit.log<br/>
ausearch -i --raw -a <EVENT-ID> --file <FILENAME> -k <KEY> --start <START-TIME> --end <END-TIME><br/>
ausearch -k etc_content                         # audit search for specific key/tag<br/>
ausearch -k etc_attribute<br/>
# Some fields (-F):
auid=The original ID the user logged in with. Its an abbreviation of audit uid. Sometimes its referred to as loginuid.<br/>
egid=Effective Group ID.<br/>
euid=Effective User ID.<br/>
sgid=Saved Group ID.<br/>
suid=Saved User ID.<br/>
uid=User ID.<br/>
3. Boot issues<br/>
# Configuring Grub2:
vim /etc/default/grub<br/>
  GRUB_TIMEOUT = seconds the menu is displayed<br/>
  GRUB_DEFAULT = starts counting from 0, what is the default entry<br/>
  GRUB_CMDLINE_LINUX = list of extra kernel params, e.g "rhgb quiet"<br/>
grub2-mkconfig -o /boot/grub2/grub.cfg          # this is *.cfg and NOT *.conf<br/>
# An example of the 'linux16' menu entry line:
linux16 /vmlinuz-3.8.0-0.40.el7.x86_64 root=/dev/mapper/rhel-root ro rd.md=0 rd.dm=0 rd.lvm.lv=rhel/swap crashkernel=auto rd.luks=0 vconsole.keymap=us rd.lvm.lv=rhel/root rhgb quiet<br/>
# Reinstalling Grub2 into the MBR, must reboot into rescue environment (e.g. anaconda):
chroot /mnt/sysimage<br/>
ls -l /boot<br/>
grub2-install /dev/vda                          # rewrite the boot loader sections of the MBR<br/>
# Reinstalling Grub2 into the UEFI:
yum reinstall grub2-efi shim                    # if the files /boot/efi have been removed<br/>
grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg # if the cfg file has been removed<br/>
yum -y install efibootmgr<br/>
efibootmgr                                      # manage list of available UEFI boot targets<br/>
efibootmgr -b 1E -B                             # delete entry 1E from UEFI boot targets completely<br/>
# Selecting a temporary boot target:
efibootmgr -n 2c                                # override normal boot ordering for a next single boot<br/>
# Add an entry (/dev/sda2 as the ESP with the application /EFI/yippie.efi on the ESP):
efibootmgr -c -d /dev/sda -p 2 -L "Yippie" -l "\EFI\yippie.efi" # (c)reate,(d)evice,(p)artition,(L)abel<br/>
# SystemD and failing services:
/etc/systemd/system/<UNITNAME>.d/               # symlinks to /usr/lib/systemd/system/<br/>
/etc/systemd/system/<UNITNAME>.requires/<SYMLINK><br/>
/etc/systemd/system/<UNITNAME>.wants/<SYMLINK><br/>

Requires=<br/>
    stopping listed unit will also stop this unit as well<br/>
RequiresOverridable=<br/>
    failed requirements will not cause the unit to fail when explicitly started<br/>
Requisite=,RequisiteOverridable=<br/>
    the unit will fail if required unit is not already running<br/>
After=<br/>
    listed units have to have finished starting before this unit can be started<br/>
Before=<br/>
    listed units will be delayed<br/>
Wants=<br/>
    when wante unit fails to start, this unit itself will still start<br/>
Conflicts=<br/>
    starting this unit will stop the conflicting units<br/>
systemctl daemon-reload                         # this is required after each change<br/>
systemctl list-dependencies <UNITNAME><br/>
systemctl list-unit-files<br/>
systemctl status                                # shows tree of services and corresponding PIDs<br/>

# To obtain a root shell during startup (/dev/tty9):
systemctl enable debug-shell.service            # do not leave this enabled after finished with debugging!<br/>
systemctl list-jobs                             # troubleshoot startup tasks<br/>

# Resetting a root password:
1. Interrupt countdown<br/>
2. Press ["e"] on the highlighted entry         # changes made like this in the Grub2 menu screen are only temporary<br/>
3. Find kernel arguments line (starts with "linux16" or "linuxefi")<br/>
4. Add "rd.break" at the end of this line by pressing ["End"]<br/>
5. ["Ctrl"]+["X"]<br/>
6. mount -oremount,rw /sysroot<br/>
7. chroot /sysroot<br/>
8. echo <PASSWORD> | passwd --stdin root<br/>
9. touch ./autorelabel (or "load_policy -i; restorecon -Rv /etc")<br/>
10. ["Ctrl"]+["D"]<br/>
4. Hardware issues<br/>
# Basic commands:
lscpu                                           # identifying processor<br/>
cat /proc/cpuinfo                               # identifying what flags CPU supports<br/>
dmidecode -t memory                             # identifying memory<br/>
lsscsi -v                                       # identifying disks<br/>
hdparm -I /dev/sda                              # more information about individual disks<br/>
lspci                                           # identifying PCI hardware<br/>
lsusb                                           # identifying USB hardware<br/>
# Memory failures:
# Older:
yum -y install mcelog                           # framework for catching and logging exceptions<br/>
# Newer:
yum -y install rasdaemon                        # modern replacement for mcelog<br/>
systemctl enable rasdaemon<br/>
systemctl start rasdaemon<br/>
ras-mc-ctl --status                             # what does subsystem know about memory<br/>
ras-mc-ctl --errors<br/>
# Test memory:
yum -y install memtest86+<br/>
memtest-setup                                   # this adds new template to Grub2 (/etc/grub.d/)<br/>
grub2-mkconfig -o /boot/grub2/grub.cfg          # update Grub2 config<br/>
# Managing Kernel modules:
ls /lib/modules/<KERNEL_VERSION>/..             # all possible drivers<br/>
lsmod                                           # view currently loaded Kernel modules (same as /sys/module/..)<br/>
modprobe -v <MODULE>                            # load the module manually<br/>
modprobe -r <MODULE>                            # unload the module manually<br/>
modinfo -p <MODULE>                             # list of supported options for the module<br/>
cat /sys/module/<MODULE>/parameters/<PARAMETER> # what is the active value of the module option<br/>
modprobe -v st buffer_kbs=64                    # set option buffer_kbs for the st module to 64 when loaded<br/>
vim /etc/modprobe.d/00-st.conf                  # automatically set every time, parsed alphabetically<br/>
  options st buffer_kbs=64 max_sg_segs=512      # permanent, needs unload & reload to take effect<br/>
# Hardware virtualization support:
modprobe -v kvm-intel                           # or 'kvm-amd'<br/>
virsh capabilities                              # usually on the host, not guest<br/>

# Overcommitting resources:
virsh nodecpustats<br/>
virsh nodememstats<br/>
virsh dommemstats <DOMAIN><br/>

# Libvirt XML config:
virsh define <FILENAME.xml>                     # attempt to create VM<br/>
xmllint --noout <FILENAME.xml>                  # verify XML syntax<br/>
virt-xml-validate <FILENAME.xml>                # verify if it matches libvirt XML schema<br/>
/etc/libvirt/qemu/networks                      # network definitions<br/>
5. Storage issues<br/>
# See the device mappings:
dmsetup ls                                      # list top level devices (e.g. VolGroup00-LogVol01 [253:1])<br/>
ls -l /dev/mapper/<LOGICAL_VOL> --> /dm-0       # symlink to device mapper#0 also in /dev/<VG_NAME><br/>
dmsetup table /dev/mapper/<LOGICAL_VOL>         # shows block device's minor/major number<br/>
ls -l /dev/vdb*                                 # or lsblk -r | awk '{ print $1, $2 }', disks & partitions<br/>
yum -y install device-mapper-multipath<br/>
multipath -v 2 <DEVICE>                         # device mapper target autoconfig<br/>
# What I/O scheduler is used with device:
cat /sys/block/<DEVICE>/queue/scheduler         # e.g. noop deadline [cfq]<br/>
yum -y install e2fsprogs<br/>
# e2fsck options:                               # 'df -TH' shows filesystems
e2fsck -b <LOCATION>                            # use alternative superblock<br/>
e2fsck -p                                       # automatically repair, only prompt un-safe problems<br/>
e2fsck -v                                       # verbose<br/>
e2fsck -y                                       # non-interactive mode, answer yes to all<br/>
# Recovering from FS corruption:
# ext3/ext4:
umount /dev/<DEVICE><br/>
e2fsck -n /dev/<DEVICE>                         # dry-run (read-only + answer no to everything)<br/>
# If corrupt supeblock (bad magic number):      # magic number = where superblock starts
dumpe2fs /dev/<DEVICE> | grep 'Backup superblock'<br/>
e2fsck [-n] /dev/<DEVICE> -b <NUMBER>           # alternative superblock to use from the previous cmd<br/>

# XFS:
yum -y install xfsprogs<br/>
umount /dev/<DEVICE>                            # re-mount on systems where journal corruption suspected<br/>
xfs_repair -n /dev/<DEVICE>                     # perform only check<br/>
xfs_repair [-o force_geometry] /dev/<DEVICE>    # perform all corrective actions, shows invalid inodes<br/>
mount /dev/<DEVICE> /mountpoint<br/>
ls /mountpoint/lost+found                       # unreferenced files<br/>
find /mountpoint -inum <NUMBER>                 # locate directory with the inode number<br/>
diff -s /file/from/backup /mountpoint/lost+found/<NUMBER><br/>
# If corrupt journal log:
xfs_repair -L /dev/<DEVICE>                     # zeros out the journal log, potentially dangerous<br/>
# Recovering LVM:
# Config file:
vim /etc/lvm/lvm.conf<br/>
  dir                                           # scan for physical volumes (/dev)<br/>
  obtain_device_list_from_udev                  # shoud udev be used (1)<br/>
  preferred_names                               # which path name to display for block device<br/>
  filter                                        # which devices to scan for presence of PV signature<br/>
  backup                                        # save text-based metadata before each disk change (1)<br/>
  backup_dir                                    # where the backup of VG metadata should be stored<br/>
  archive                                       # should old configurations be also archived (1)<br/>
  archive_dir                                   # where the archives will be stored<br/>
  retain_min                                    # minimum number of archives to store<br/>
  retain_days                                   # minimum number of days for archive to be kept<br/>

# Reverting LVM changes:
ls /etc/lvm/backup/<VG_NAME><br/>
cat /etc/lvm/archive/<VG_NAME>_timestamp.vg | grep 'description ='<br/>
vgcfgrestore -l <VG_NAME>                       # list descriptions of each archives of the volume group<br/>
umount ALL FS CREATED ON THE LOGICAL VOLUME<br/>
vgcfgrestore -f /etc/lvm/archive/<VG_NAME>_timestamp.vg<br/>
lvchange -an /dev/<VG_NAME>/<LV_NAME>           # activate no (deactivate)<br/>
lvchange -ay /dev/<VG_NAME>/<LV_NAME>           # activate yes (reactivate)<br/>
xfs_growfs /dev/<VG_NAME>/<LV_NAME>             # eventually grow the filesystem if needed<br/>
mount ALL FS CREATED ON THE LOGICAL VOLUME<br/>
# Dealing with LUKS:
dmsetup ls --target crypt                       # e.g. 'luks-0123456789-abcde-987654321-fghij (253,0)'<br/>
cat /etc/crypttab                               # may contain UUID instead of ENCDEVICE<br/>
  <NAME> /dev/<ENCDEVICE> /path/keyfile or none # if none, you will be asked for password on boot<br/>
/dev/mapper/<NAME>                              # decrypted device mapper location<br/>
cryptsetup luksDump /dev/<ENCDEVICE>            # display LUKS header information for encrypted device<br/>

# LUKS header backup:
cryptsetup luksHeaderBackup /dev/<ENCDEVICE> --header-backup-file /path/to/backup_file<br/>
# Trial decryption with header backup file:     # use 'cryptsetup luksClose' when you make a typo
cryptsetup luksOpen /dev/<ENCDEVICE> <NAME> [--header /path/to/backup_file]<br/>
cryptsetup luksOpen <FILE.img> <NAME> --key-file <EXISTING_KEY_FILE.key><br/>
# Add key to the key slot:
cryptsetup luksAddKey /dev/<ENCDEVICE> --key-file <EXISTING_KEY_FILE.key> --key-slot <ID> [<key file with new key or pswd>]<br/>
# Restore header:
cryptsetup luksHeaderRestore /dev/<ENCDEVICE> --header-backup-file /path/to/backup_file<br/>
# iSCSI initiator/client:
yum -y install iscsi-initiator-utils            # 'systemctl enable iscsi --now'<br/>
iscsiadm -m node                                # see already discovered targets/node records<br/>
iscsiadm -m session [-P 3]                      # validate sessions or connections, P=print level<br/>
vim /etc/iscsi/iscsid.conf                      # restart iscsi/iscsid every time you change this file<br/>
  discovery.sendtargets.auth.<authmetod|username|password|username_in|password_in><br/>
  node.session.auth.<authmetod|username|password|username_in|password_in><br/>
vim /etc/iscsi/initiatorname.iscsi              # this needs iscsid restart<br/>
  InitiatorName=iqn.2016-01.com.example.lab:servera<br/>
systemctl restart iscsid<br/>
iscsiadm -m discovery -t st -p <TARGET>:<PORT>  # discovery & sendtargets for portal -> /var/lib/iscsi/nodes<br/>
iscsiadm -m node -T iqn.2016-01.com.example.lab:iscsistorage --login [-d8] # -d8=debug<br/>
# Disable CHAP authentication:
iscsiadm -m node -T iqn.2016-01.com.example.lab:iscsistorage -o update -n node.session.auth.authmethod \<br/>
  -v None [-p <TARGET>:<PORT>]                  # o=overwrite previous config,n=name,v=value<br/>
# Purge all node information from cache, recommended when server's setting change:
iscsiadm -m node -T iqn.2016-01.com.example.lab:iscsistorage -o delete [-p <TARGET>:<PORT>]<br/>
# Purge all know nodes from cache:
iscsiadm -m node -o delete [-p <TARGET>:<PORT>] # default port 3260/tcp<br/>
lsblk --scsi<br/>
6. RPM issues<br/>
# Display package dependencies:
yum deplist <PACKAGE>                           # same as rpm -q -R <PACKAGE><br/>
# Resolving package dependencies:
yum downgrade <PACKAGE>                         # same as rpm -U --oldpackage <PACKAGE><br/>
rpm -U --force <PACKAGE>                        # same as --oldpackage --replacepkgs --replacefiles<br/>
# Using YUM to lock package versions:           # 'yum list available yum-plugin*'
yum -y install yum-plugin-versionlock<br/>
yum versionlock list                            # display list of locked package versions<br/>
yum versionlock add <PATTERN>                   # lock current versions of packages matched by wildcard<br/>
yum versionlock delete <PATTERN>                # delete locks matched by wildcard<br/>
yum versionlock clear                           # clear all package version locks<br/>
yum list --showduplicates <PACKAGE>\*           # find all available versions of a package<br/>
# Repair corrupt RPM database:
lsof | grep /var/lib/rpm<br/>
rm /var/lib/rpm/__db*                           # remove database indexes<br/>
tar cjvf rpmdb-$(date +%Y%m%d-%H%M).tar.bz2 /var/lib/rpm<br/>
cd /var/lib/rpm<br/>
/usr/lib/rpm/rpmdb_verify Packages              # verify RPM database integrity<br/>
mv Packages Packages.bad<br/>
/usr/lib/rpm/rpmdb_dump Packages.bad | /usr/lib/rpm/rpmdb_load Packages<br/>
/usr/lib/rpm/rpmdb_verify Packages<br/>
rpm -v --rebuilddb                              # rebuild database indexes, 'rpm -qa > /dev/null' shouldn't show anything<br/>
# Verifying changed files with RPM:
rpm -qf <PATH>                                  # what package does the file belong to<br/>
rpm -ql <PACKAGE>                               # list files in package<br/>
tail /var/log/yum.log                           # see what was installed recently<br/>
rpm -V <PACKAGE(S)>                             # verify the package (S,M,5,L,U,G,T), shows file types (c,d,l,r) for some<br/>
rpm -Va                                         # verify files of all installed packages<br/>
# Verifying changes with YUM:
yum -y install yum-plugin-verify                # works like 'rpm -V'<br/>
yum verify <PACKAGE>                            # does not show configuration files changes<br/>
yum verify-rpm <PACKAGE>                        # includes configuration files diff from original<br/>
# Recovering changed files:
rpm --setperms <PACKAGE>                        # resets the permissions of files in a package<br/>
rpm --setguids <PACKAGE>                        # resets the user/group ownership of files<br/>
yum reinstall <PACKAGE>                         # repair installed package<br/>
7. Network issues
ping -c 1 -W 3 <IPv4>                           # send single echo request and wait 3s for reply<br/>
ping6 [-I <INTERFACE>] <IPv6>                   # -I is not needed when routable IPv6 is used<br/>

# Scanning the network:
yum -y install nmap<br/>
nmap -n <IPv4>/<SUBNET>                         # -n means don't use DNS, discover all ports on all hosts<br/>
nmap -n -sn <IPv4>/<SUBNET>                     # -sn means disable port scanning, only discover hosts<br/>
nmap -n -sU <IPv4>                              # perform UDP scan on the host<br/>
nmap <HOSTNAME>                                 # perform IPv4 port scan on hostname<br/>
nmap -6 <HOSTNAME>                              # scan ports of the IPv6 address<br/>

# Read/write data across networks:
yum -y install nmap-ncat<br/>
nc <HOSTNAME> <PORT>                            # client/connect mode<br/>
nc -6 <HOSTNAME> <PORT>                         # connect to port of hostname using IPv6<br/>
nc -l [-k] <PORT>                               # server mode, -k means keep listening for >1 connections<br/>
nc -l <PORT> -e <COMMAND>                       # pass incoming traffic to the command<br/>

# Monitoring using IPTraf:
yum -y install iptraf-ng<br/>
iptraf-ng<br/>
# Network devices naming:                       # view /usr/share/doc/initscripts-*/sysconfig.txt
cat /etc/udev/rules.d/80-net-name-slot.rules    # udev rules with persistent naming<br/>
vim /etc/udev/rules.d/70-persistent-net.rules   # these custom rules overwrite defaults<br/>
cat /etc/sysconfig/network-scripts/ifcfg-eth1   # filename should match device name<br/>
  DEVICE=<NAME><br/>
  HWADDR=<MAC_ADDRESS><br/>
  BOOTPROTO=STATIC                              # static/none (needs IPADDR0,PREFIX0) or dhcp/bootp<br/>
  ONBOOT=yes<br/>
  TYPE=Ethernet<br/>
  USERCTL=yes<br/>
  PEERDNS=no                                    # define entries in /etc/resolv.conf (needs DNS1,DNS2)<br/>
  IPV6INIT=no                                   # use IPv6 (needs IPV6ADDR/MASK,IPV6_AUTOCONF)<br/>
  IPADDR=<IPv4><br/>
  NETMASK=<MASK><br/>

# Troubleshooting:
ip addr show dev <DEVICE_NAME><br/>
ip route<br/>
nmcli con                                       # display connection information<br/>
nmcli dev                                       # display device information<br/>
nmcli conn show '<CONNECTION_NAME>' | grep ipv  # all config settings<br/>
  ipv4.method                                   # auto=dhcp, manual=static (needs addresses,gateway)<br/>
  ipv6.method<br/>
ncmli conn mod '<CONNECTION_NAME>' ipv4.dns '<IPv4>' # good alternative: 'nmtui', restart affected services<br/>
nmcli conn reload                               # after you manually edit network-scripts<br/>
nmcli conn down '<CONNECTION_NAME>' ; nmcli \   # changes are not applied to already active interface...<br/>
  conn up '<CONNECTION_NAME>'                   # ...also updates /etc/resolv.conf<br/>
firewall-cmd --list-all-zones [--permanent]     # comparing active and permanent can identify problems<br/>
firewall-cmd --runtime-to-permanent             # quick convert of runtime rules to permanent<br/>
host -v -t aaaa <HOSTNAME> <DNS>                # query DNS for hostname's IPv6<br/>
# Inspecting network traffic:
yum -y install wireshark-gnome<br/>
wireshark &<br/>
wireshark -r <FILE> &                           # analyze captured packets previously saved in file<br/>

# Capturing packets:                            # yum -y install tcpdump
tcpdump -c <NUMBER> -w <FILE.pcap>              # capture number of packets to the file<br/>
tcpdump -r <FILE.pcap>                          # read from a capture file<br/>
tcpdump 'host <HOSTNAME>'                       # coming to/from host<br/>
tcpdump 'src <HOSTNAME>'                        # from host<br/>
tcpdump 'port <NUMBER>'
tcpdump 'icmp and host <IPv4>'                  # icmp to/from host<br/>
tcpdump 'ip host <HOSTNAME1> and not <HOSTNAME2>'
tcpdump -x                                      # display packet header and hexadecimal values<br/>
tcpdump -X                                      # display data as hexadecimal and ASCII values<br/>
tcpdump -X -r <FILE.pcap> 'host <HOSTNAME>' | grep -i 'pass' # display plaintext passwords<br/>
8. Application issues<br/>
# Linking against shared libraries (.so=shared object):
objdump -p /usr/lib64/<LIBRARY>-<VER>.so | grep SONAME<br/>
ls -l /usr/lib64/<LIBRARY>*                     # shared library has symbolic link to DT_SONAME field<br/>
ls -l /lib64/ld-linux-x86-64.so*                # default 64-bit runtime linker on RHEL7<br/>
ls -l /lib/ld-linux.so*                         # default 32-bit runtime linker on RHEL7<br/>
ldconfig [-v]                                   # updates the runtime linker cache<br/>
ldconfig -p                                     # list of libraries in /etc/ld.so.cache<br/>
ldd <PATH/TO/EXECUTABLE>                        # required shared libraries by executable (| grep 'not found')<br/>
yum whatprovides '*lib/<LIBRARY>.so.0'          # identify package that provides shared library<br/>
rpm -q --requires -p <FILE>.rpm                 # required runtime libraries are stored in RPM metadata<br/>
# Diagnosing memory leaks:
yum -y install valgrind<br/>
valgrind --tool=memcheck --leak-check=full <PROGRAM><br/>
watch -d -n1 'free -mh; grep -i commit /proc/meminfo'<br/>
# Displaying system calls:
strace [-o <FILE> -e <SYSCALLS>] <EXECUTABLE>   # launch executable with strace, -o=to file,-e=show only specific events<br/>
strace -f <EXECUTABLE>                          # also follow the execution of forks (child processes)<br/>
strace -p <PID>                                 # trace a process already executed<br/>

# Displaying library calls:
ltrace -S <EXECUTABLE>                          # strace + ltrace (needs at least read access to executable)<br/>
ltrace -p <PID>                                 # trace a process already executed<br/>
9. Security issues<br/>
# SELinux logging (or /var/log/audit/audit.log):
ausearch -m avc -ts recent                      # display Access Vector Control messages, last 10mins<br/>

yum -y install setools-console                  # provides "seinfo", "sesearch"<br/>
sesearch -D                                     # full list of all active "dontaudit" rules<br/>
sesearch --allow -b <BOOLEAN>                   # view allow rules enabled by the boolean<br/>
semanage dontaudit off                          # disable "dontaudit" rules until it is turned 'dontaudit on' - blocks events, but does not log them<br/>
seinfo -t httpd_sys_content_t                   # or -b to show booleans<br/>
seinfo --portcon=443 --protocol=tcp<br/>
# An example of USER_AUTH entry in the audit log:
type=USER_AUTH msg=audit(1564120484.274:12873): pid=22300 uid=0 auid=1000 ses=2 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 msg='op=PAM:authentication grantors=pam_rootok acct="root" exe="/usr/bin/su" hostname=localhost.localdomain addr=? terminal=pts/0 res=success'<br/>
# Troubleshooting SELinux:
yum -y install setroubleshoot-server            # provides 'sealert', 'sedispatch' plugin for auditd<br/>
service auditd restart                          # auditd's sedispatch plugin requires restart, don't use systemd<br/>
sealert -l <UUID_OF_DENIAL><br/>
sealert -a /var/log/audit/audit.log             # parse all denial messages out of file<br/>

# Common issues:
semanage fcontext -a -t <TYPE> '<PATH>(/.*)?'   # add path to the list of standard file contexts<br/>
restorecon -Rv <PATH>                           # apply the new file contexts<br/>
touch /.autorelabel                             # perform automatic relabel of all files after disabled->enforcing, which causes all files to be 'unlabeled_t'<br/>
semanage boolean --list                         # current/default state + description of all SELinux toggles<br/>
setsebool -P <BOOLEAN=ON/OFF>                   # boolean values updated permanently, without -P only in memory<br/>
semanage port -a -t <TYPE> -p tcp <PORT>        # label an unlabeled port (e.g. http_port_t on port 8001 etc.)<br/>
# vsftpd public directory, where anonymous are allowed to write:
semanage fcontext -a -t public_content_rw_t '/var/ftp/pub(/.*)?'<br/>
setsebool -P allow_ftpd_anon_write=1<br/>
# Configuring PAM (Pluggable Authentication Modules):
vim /etc/pam.d/<SERVICE>                        # if none is found, /etc/pam.d/other will block all access<br/>
  type control module-path [module-arguments]   # shouldn't be configured by hand, but by "authconfig" tools<br/>

# Troubleshooting PAM:
tail -f /var/log/secure<br/>
journalctl -u <PROBLEMATIC_SERVICE>             # good start for logging issues: 'journalctl _COMM=login'<br/>
rpm -V <PROBLEMATIC_SERVICE>                    # did the files belonging to service change, especially PAM config?<br/>
mv /etc/pam.d/<PROBLEMATIC_FILE>{,.broken}      # rename broken PAM config, otherwise reinstall will not touch it<br/>
yum reinstall <PROBLEMATIC_SERVICE><br/>
diff -u /etc/pam.d/<PROBLEMATIC_FILE>{,.broken} # compare good and bad PAM config of problematic service<br/>
authconfig<br/>
authconfig-tui<br/>
authconfig-gtk<br/>
authconfig --updateall                          # recreate all configuration files and re-apply the configuration as stored in /etc/sysconfig/authconfig<br/>
yum -y install pam_krb5                         # when the module for Kerberos is missing<br/>
# Solving LDAP issues:
yum -y install openldap-clients                 # set of tools<br/>
cat /etc/openldap/ldap.conf                     # LDAP defaults (BASE,URI etc.), usually port TCP/389 with STARTTLS<br/>
mv <CRT> /etc/openldap/cacerts;cacertdir_rehash # when CAs mismatches are happening, this needs to be done<br/>
ldapsearch -x -ZZ -LL '(uid=ldapsuer)' \<br/>
  cn homeDirectory                              # -x simple auth, -ZZ enforce TLS, -LL disable comments in output, only return canonical name and home directory<br/>
getent passwd <LDAP_USER>                       # uses nsswitch.conf to query backend password systems<br/>
# Solving Kerberos issues:
kinit <USER>                                    # obtain TGT (ticket granting ticket), time must match everywhere!<br/>
cat /etc/krb5.conf | grep -A 1 domain_realm     # is the [domain_realm] section correct in Kerberos5 config?<br/>
yum -y install sssd-common<br/>
man sssd-krb5                                   # when System Security Services Daemon is used (krb5_server,krb5_realm)<br/>
/etc/sssd/sssd.conf                             # this cache may contain KRB5 as well. Change needs restart of sssd<br/>
yum -y install krb5-workstation<br/>
klist                                           # check if the user received TGT<br/>
klist -ek /etc/krb5.keytab                      # inspect keytabs, KVNO shows version of the password stored. When you overwrite Keytab file with a new one, dependant services (e.g. NFS) must be restarted<br/>
cat /etc/exports.d/* /etc/auto.guests /etc/fstab # sec=krb5i vs. sec=krb5p = they must match everywhere, needs autofs restart<br/>
ssh -o PreferredAuthentications=keyboard-interactive,password ldapuser@server # when testing LDAP instead of SSH key auth<br/>
10. Kernel issues<br/>
# kdump & kexec:
yum -y install kexec-tools system-config-kdump  # provides graphical configuration tool for kdump<br/>
cat /etc/default/grub | grep GRUB_CMDLINE_LINUX<br/>
  ... crashkernel=auto ...                      # after adding this, run "grub2-mkconfig -o ..."<br/>
cat /etc/kdump.conf | grep ^path                # by default crash dumps go to /var/crash/<IP>-<DATE> (raw,nfs,ssh is possible)<br/>
cat /etc/kdump.conf | grep ^core_collector      # by default collection is done by "makedumpfile" utility<br/>
vim /etc/kdump.conf<br/>
  core_collector scp                            # collection of crash dumps using SSH dump targets (needs ssh,ssh_key)<br/>
makedumpfile -l --message-level 1 -d 31         # lzo compression, only progress indicator, exclude some pages (-d=dump level)<br/>
man 8 makedumpfile                              # -c=zlib, -l=lzo, -p=snappy, message level 1=Only include progress indicator, 4=Only include error messages, 31=Include all messages<br/>
systemctl enable --now kdump                    # enables and starts, must be restarted when config file is changed<br/>
kdumpctl status<br/>
kdumpctl showmem                                # how much memory is reserved for crash kernel<br/>
kdumpctl propagate                              # simplify setup of SSH key (sshkey in kdump.conf) authentication<br/>
# Kernel crash dump triggers:                   # 'sysctl -a | grep -e kernel -e vm' is helpful if you don't remember them
echo "vm.panic_on_oom=1" >> /etc/sysctl.conf    # panic on OOM-killer events permanently<br/>
echo "kernel.hung_task_panic=1" >> /etc/sysctl.conf # panic on hung process perm<br/>
cat /proc/sys/kernel/hung_task_timeout_secs     # hung task timeout<br/>
echo "kernel.softlockup_panic=1" >> /etc/sysctl.conf # soft lockups (kernel loops in kernel mode) perm<br/>
echo "kernel.panic_on_io_nmi=1" >> /etc/sysctl.conf # nonrecoverable HW failure (NMI) perm<br/>
echo "kernel.sysrq=1" >> /etc/sysctl.conf       # enable all magic sysrq (key sequence in case of unresponsive system) perm<br/>
echo "c" > /proc/sysrq-trigger                  # initiate a system crash (other sysrq keys: m,t,p,c,s,u,b,9,f,w)<br/>
sysctl -p                                       # load in Kernel parameters<br/>
# Analyzing kernel crash dumps:
yum -y install kernel-debuginfo<br/>
strings vmcore | head                           # same info as vmcore-dnesg.txt<br/>
crash /usr/lib/debug/modules/<KERNEL_VER>/vmlinux \<br/>
  /var/crash/<IP_ADDRESS-DATE-TIME>             # it needs debug version of the kernel image and crash dump<br/>
# Kernel debugging with SystemTap:
# Install software needed to compile SystemTap modules:
subscription-manager repos --enable rhel-7-server-debug-rpms<br/>
yum -y install kernel-debuginfo kernel-devel systemtap<br/>
stap-prep                                       # checks current kernel and install matching devel & debuginfo<br/>
ls /usr/share/doc/systemtap-client-*/examples   # useful *.stp scripts from systemtap package<br/>
stap -v /usr/share/doc/systemtap-client-*/examples/process/syscalls_by_proc.stp<br/>
# Compile a kernel stap module to a specific dir:
stap -p 4 -v -m syscalls_by_proc \              # generates *.ko in the current dir, '-p 4'=only first 4 steps, -m=filename<br/>
  /usr/share/doc/systemtap-client-*/examples/process/syscalls_by_proc.stp<br/>
# Make module available for users in "stapusr" group:
mkdir /lib/modules/$(uname -r)/systemtap        # must be owned by root and not be world writable<br/>
ls -ld /lib/modules/$(uname -r)/systemtap<br/>
cp /root/syscalls_by_proc.ko /lib/modules/$(uname -r)/systemtap<br/>
staprun syscalls_by_proc                        # run the module, doesn't need to specify extension here<br/>

# For only the SystemTap runtime environment you need a single package:
yum -y install systemtap-runtime
man -P 'less +/PERMISSIONS' stap                # see the PERMISSIONS section of the stap manpage for all the details
# User in "stapdev" & "stapusr" groups can run the module from anywhere (do this on the destination machine):
usermod -aG stapusr <USER>                      # can run SystemTap modules, but only if they exist in the /lib/modules/$(uname -r)/systemtap dir
usermod -aG stapdev <USER>                      # may compile their own SystemTap instrumentation kernel modules using stap, if they are al
